<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebase Tool Dashboard</title>
    <!-- Tabler CSS -->
    <link href="https://unpkg.com/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tabulator CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css" rel="stylesheet">
    <!-- Tabulator Bootstrap 5 Theme CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator_bootstrap5.min.css" rel="stylesheet">
    <!-- Tabulator JS -->
    <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
    <style>
    /* Make Tabulator pagination/footer match Bootstrap card */
    .tabulator .tabulator-footer {
        background: #fff !important;
        border-top: 1px solid #dee2e6 !important;
        color: #212529;
    }
    .tabulator .tabulator-paginator label,
    .tabulator .tabulator-paginator input,
    .tabulator .tabulator-paginator select {
        background: #fff !important;
        color: #212529 !important;
        border: 1px solid #ced4da !important;
        border-radius: 0.25rem;
        margin: 0 2px;
        padding: 2px 6px;
        font-size: 1rem;
    }
    .tabulator .tabulator-paginator button {
        background: #f8f9fa !important;
        color: #212529 !important;
        border: 1px solid #ced4da !important;
        border-radius: 0.25rem;
        margin: 0 2px;
        padding: 2px 10px;
        font-size: 1rem;
        transition: background 0.2s;
    }
    .tabulator .tabulator-paginator button.active,
    .tabulator .tabulator-paginator button:focus {
        background: #0d6efd !important;
        color: #fff !important;
        border-color: #0d6efd !important;
    }
    .tabulator-header .tabulator-col select {
        min-width: 120px;
        padding: 2px 8px;
        border-radius: 0.25rem;
        border: 1px solid #ced4da;
        background: #fff;
        color: #212529;
        font-size: 1rem;
    }
    </style>
</head>
<body class="bg-light">
    <div class="page">
        <header class="navbar navbar-expand-md navbar-light bg-white shadow-sm mb-4">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#">rebase_tool</a>
                <div class="d-none d-md-block ms-4 text-muted small">
                    <a href="#" id="beta-link" class="text-decoration-none text-muted">
                        <span id="beta-version">E2E Beta 910100</span>
                    </a>
                    &nbsp; <span id="beta-datetime">Apr 24, 2024, 07:15 AM</span> &nbsp; 
                    Commit: <span class="badge bg-secondary">a1b2c3d4</span>
                </div>
                <ul class="nav nav-tabs ms-auto" id="dashboardTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tab-current" data-bs-toggle="tab" data-bs-target="#current-build" type="button" role="tab">Current Build</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-history" data-bs-toggle="tab" data-bs-target="#historical-trends" type="button" role="tab">Numeric Rebase History</button>
                    </li>
                </ul>
            </div>
        </header>
        <main class="container-fluid">
            <div class="tab-content" id="dashboardTabContent">
                <div class="tab-pane fade show active" id="current-build" role="tabpanel">
                    <div class="row g-3 mb-4">
                        <div class="col-6 col-md-3">
                            <div class="card text-center border-0 shadow-sm" data-bs-toggle="tooltip" title="Number of tests currently failing in this build.">
                                <div class="card-body">
                                    <div class="fs-2 text-danger">üß™ <span id="failing-tests-count"></span></div>
                                    <div class="text-muted">Failing Tests</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center border-0 shadow-sm" data-bs-toggle="tooltip" title="Number of changes that were uniquely identified for rebase.">
                                <div class="card-body">
                                    <div class="fs-2 text-success">‚úÖ <span id="uniquely-identified-count"></span></div>
                                    <div class="text-muted">Change uniquely identified</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center border-0 shadow-sm" data-bs-toggle="tooltip" title="Number of changes that could not be uniquely identified.">
                                <div class="card-body">
                                    <div class="fs-2 text-warning">‚ùì <span id="not-uniquely-identified-count"></span></div>
                                    <div class="text-muted">Change not uniquely identified</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card text-center border-0 shadow-sm" data-bs-toggle="tooltip" title="Number of changes for which rebase is unavailable.">
                                <div class="card-body">
                                    <div class="fs-2 text-secondary">üö´ <span id="rebase-unavailable-count"></span></div>
                                    <div class="text-muted">Rebase unavailable</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-4">
                        <div class="card-header fw-bold">Failing Tests</div>
                        <div class="table-responsive">
                            <div id="failing-tests-table"></div>
                        </div>
                    </div>
                    <script>
                    // Test status variables (can be updated externally)
                    var testStatus = {
                        failingTests: 150,
                        uniquelyIdentified: 120,
                        notUniquelyIdentified: 20,
                        rebaseUnavailable: 10
                    };

                    // Beta build information variables (can be updated externally)
                    var betaInfo = {
                        version: 'E2E Beta 910100',
                        datetime: 'Apr 24, 2024, 07:15 AM',
                        link: '#'
                    };

                    document.addEventListener('DOMContentLoaded', function() {
                        // Update test status cards
                        document.getElementById('failing-tests-count').textContent = testStatus.failingTests;
                        document.getElementById('uniquely-identified-count').textContent = testStatus.uniquelyIdentified;
                        document.getElementById('not-uniquely-identified-count').textContent = testStatus.notUniquelyIdentified;
                        document.getElementById('rebase-unavailable-count').textContent = testStatus.rebaseUnavailable;

                        // Update beta information
                        document.getElementById('beta-version').textContent = betaInfo.version;
                        document.getElementById('beta-datetime').textContent = betaInfo.datetime;
                        document.getElementById('beta-link').href = betaInfo.link;

                        var tableData = [
                            { test: "test_login_timeout", status: "PR #125", builds: "81234567 ‚Üí 81234789", details: "reports/pr_452_report.html" },
                            { test: "test_ui_theme_load", status: "Unable to uniquely identify library change", builds: "81234567 ‚Üí 82345678", details: null },
                            { test: "test_profile_update", status: "PR #126", builds: "81234567 ‚Üí 81234789", details: "reports/pr_453_report.html" },
                            { test: "test_signup_flow", status: "Rebase unavailable", builds: "82345678 ‚Üí 83456789", details: null },
                            { test: "test_password_reset", status: "PR #127", builds: "81234567 ‚Üí 82345678", details: "reports/pr_454_report.html" },
                            { test: "test_email_verification", status: "Unable to uniquely identify library change", builds: "83456789 ‚Üí 84567890", details: null },
                            { test: "test_dashboard_load", status: "PR #128", builds: "81234567 ‚Üí 81234789", details: "reports/pr_455_report.html" },
                            { test: "test_notification_popup", status: "Rebase unavailable", builds: "82345678 ‚Üí 84567890", details: null },
                            { test: "test_user_logout", status: "PR #129", builds: "81234567 ‚Üí 82345678", details: "reports/pr_456_report.html" },
                            { test: "test_theme_switch", status: "Unable to uniquely identify library change", builds: "83456789 ‚Üí 85678901", details: null },
                            { test: "test_profile_picture_upload", status: "PR #130", builds: "82345678 ‚Üí 83456789", details: "reports/pr_457_report.html" },
                            { test: "test_data_export", status: "Rebase unavailable", builds: "84567890 ‚Üí 85678901", details: null },
                            { test: "test_import_csv", status: "PR #131", builds: "81234567 ‚Üí 83456789", details: "reports/pr_458_report.html" },
                            { test: "test_search_function", status: "Unable to uniquely identify library change", builds: "83456789 ‚Üí 84567890", details: null },
                            { test: "test_user_registration", status: "PR #132", builds: "82345678 ‚Üí 85678901", details: "reports/pr_459_report.html" },
                            { test: "test_api_rate_limit", status: "Rebase unavailable", builds: "84567890 ‚Üí 86789012", details: null },
                            { test: "test_session_expiry", status: "PR #133", builds: "83456789 ‚Üí 84567890", details: "reports/pr_460_report.html" },
                            { test: "test_multi_factor_auth", status: "Unable to uniquely identify library change", builds: "85678901 ‚Üí 86789012", details: null },
                            { test: "test_user_preferences", status: "PR #134", builds: "84567890 ‚Üí 86789012", details: "reports/pr_461_report.html" },
                            { test: "test_audit_log", status: "Rebase unavailable", builds: "85678901 ‚Üí 87890123", details: null }
                        ];
                        new Tabulator("#failing-tests-table", {
                            data: tableData,
                            layout: "fitColumns",
                            pagination: "local",
                            paginationSize: 20,
                            columns: [
                                { title: "Test Name", field: "test", headerFilter: true, width: "30%" },
                                { 
                                    title: "Status", 
                                    field: "status", 
                                    headerFilter: "list",
                                    headerFilterParams: {
                                        values: {
                                            "": "All",
                                            "PR #125": "PR #125",
                                            "PR #126": "PR #126",
                                            "Unable to uniquely identify library change": "Unable to uniquely identify library change",
                                            "Rebase unavailable": "Rebase unavailable"
                                        }
                                    },
                                    formatter: function(cell) {
                                        var val = cell.getValue();
                                        if(val && val.startsWith('PR #')) {
                                            var prNumber = val.match(/PR #(\d+)/);
                                            if(prNumber) {
                                                var url = `https://github.com/yourorg/yourrepo/pull/${prNumber[1]}`;
                                                return `<a href='${url}' target='_blank' class='badge bg-primary text-decoration-none'>${val}</a>`;
                                            }
                                            return `<span class='badge bg-primary'>${val}</span>`;
                                        } else if(val === "Unable to uniquely identify library change") {
                                            return `<span class='badge bg-warning text-dark'>${val}</span>`;
                                        } else if(val && val.startsWith('Branch #')) {
                                            return `<span class='badge bg-info text-dark'>${val}</span>`;
                                        } else if(val === "Rebase unavailable") {
                                            return `<span class='badge bg-secondary'>Rebase unavailable</span>`;
                                        } else {
                                            return val;
                                        }
                                    }
                                },
                                { 
                                    title: "Passing ‚Üí Failing", 
                                    field: "builds", 
                                    headerFilter: true,
                                    formatter: function(cell) {
                                        var val = cell.getValue();
                                        if(val && val.includes('‚Üí')) {
                                            // Generate consistent color based on the entire build transition
                                            function getBuildTransitionColor(buildTransition) {
                                                var hash = 0;
                                                for (var i = 0; i < buildTransition.length; i++) {
                                                    hash = buildTransition.charCodeAt(i) + ((hash << 5) - hash);
                                                }
                                                var hue = Math.abs(hash % 360);
                                                return `hsl(${hue}, 70%, 90%)`;
                                            }
                                            
                                            var transitionColor = getBuildTransitionColor(val);
                                            
                                            return `<span style='background-color: ${transitionColor}; padding: 2px 4px; border-radius: 3px; display: inline-block;'>${val}</span>`;
                                        }
                                        return val;
                                    }
                                },
                                { title: "Details", field: "details", hozAlign: "center", formatter: function(cell) {
                                    var url = cell.getValue();
                                    if(url) {
                                        return `<a href='${url}' target='_blank' class='btn btn-sm btn-outline-primary'>View</a>`;
                                    } else {
                                        return `<button class='btn btn-sm btn-outline-secondary' disabled>‚Äî</button>`;
                                    }
                                } }
                            ],
                            height: "800px",
                            responsiveLayout: true,
                            movableColumns: true,
                            tooltips: true,
                        });
                    });
                    </script>
                </div>
                <div class="tab-pane fade" id="historical-trends" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-header fw-bold">Numeric Rebase History</div>
                        <div class="table-responsive">
                            <div id="numeric-history-table"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Bootstrap 5 JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Initialize Bootstrap tooltips
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Global variable to track numeric history table initialization
        let numericHistoryTable = null;

        // Function to initialize numeric history table
        function initializeNumericHistoryTable() {
            // Check if table already exists
            if (numericHistoryTable) {
                return;
            }

            // Check if Tabulator is loaded
            if (typeof Tabulator === 'undefined') {
                console.error('Tabulator library not loaded');
                return;
            }

            const numericHistoryData = [
                { 
                    commit: "a1b2c3d4", 
                    commitTime: "2024-04-24 07:15:22", 
                    test: "test_numerical_precision", 
                    testCategories: "Math, Precision", 
                    release: "v2.1.0", 
                    maxAbsDiff: 0.0001, 
                    maxRelDiff: 0.05, 
                    lengthMismatch: 0 
                },
                { 
                    commit: "b2c3d4e5", 
                    commitTime: "2024-04-23 14:30:15", 
                    test: "test_array_operations", 
                    testCategories: "Arrays, Performance", 
                    release: "v2.0.9", 
                    maxAbsDiff: 0.002, 
                    maxRelDiff: 0.12, 
                    lengthMismatch: 2 
                },
                { 
                    commit: "c3d4e5f6", 
                    commitTime: "2024-04-22 09:45:33", 
                    test: "test_matrix_multiplication", 
                    testCategories: "Math, Linear Algebra", 
                    release: "v2.0.8", 
                    maxAbsDiff: 0.0005, 
                    maxRelDiff: 0.03, 
                    lengthMismatch: 0 
                },
                { 
                    commit: "d4e5f6g7", 
                    commitTime: "2024-04-21 16:20:41", 
                    test: "test_statistical_functions", 
                    testCategories: "Statistics, Math", 
                    release: "v2.0.7", 
                    maxAbsDiff: 0.01, 
                    maxRelDiff: 0.25, 
                    lengthMismatch: 1 
                },
                { 
                    commit: "e5f6g7h8", 
                    commitTime: "2024-04-20 11:55:18", 
                    test: "test_floating_point_calc", 
                    testCategories: "Math, Precision", 
                    release: "v2.0.6", 
                    maxAbsDiff: 0.00001, 
                    maxRelDiff: 0.01, 
                    lengthMismatch: 0 
                },
                { 
                    commit: "f6g7h8i9", 
                    commitTime: "2024-04-19 13:12:07", 
                    test: "test_vector_operations", 
                    testCategories: "Math, Vectors", 
                    release: "v2.0.5", 
                    maxAbsDiff: 0.003, 
                    maxRelDiff: 0.15, 
                    lengthMismatch: 3 
                },
                { 
                    commit: "g7h8i9j0", 
                    commitTime: "2024-04-18 08:33:52", 
                    test: "test_regression_analysis", 
                    testCategories: "Statistics, Analysis", 
                    release: "v2.0.4", 
                    maxAbsDiff: 0.02, 
                    maxRelDiff: 0.18, 
                    lengthMismatch: 0 
                },
                { 
                    commit: "h8i9j0k1", 
                    commitTime: "2024-04-17 15:47:29", 
                    test: "test_numerical_integration", 
                    testCategories: "Math, Calculus", 
                    release: "v2.0.3", 
                    maxAbsDiff: 0.0008, 
                    maxRelDiff: 0.04, 
                    lengthMismatch: 0 
                },
                { 
                    commit: "i9j0k1l2", 
                    commitTime: "2024-04-16 10:22:14", 
                    test: "test_optimization_algo", 
                    testCategories: "Algorithms, Optimization", 
                    release: "v2.0.2", 
                    maxAbsDiff: 0.05, 
                    maxRelDiff: 0.30, 
                    lengthMismatch: 5 
                },
                { 
                    commit: "j0k1l2m3", 
                    commitTime: "2024-04-15 12:08:36", 
                    test: "test_fourier_transform", 
                    testCategories: "Math, Signal Processing", 
                    release: "v2.0.1", 
                    maxAbsDiff: 0.001, 
                    maxRelDiff: 0.08, 
                    lengthMismatch: 1 
                }
            ];

            try {
                numericHistoryTable = new Tabulator("#numeric-history-table", {
                    data: numericHistoryData,
                    layout: "fitColumns",
                    pagination: "local",
                    paginationSize: 15,
                    columns: [
                        { 
                            title: "Commit", 
                            field: "commit", 
                            headerFilter: true, 
                            width: "10%",
                            formatter: function(cell) {
                                const val = cell.getValue();
                                return `<code class="text-primary">${val}</code>`;
                            }
                        },
                        { 
                            title: "Commit Time", 
                            field: "commitTime", 
                            headerFilter: true, 
                            width: "15%",
                            formatter: function(cell) {
                                const val = cell.getValue();
                                const date = new Date(val);
                                return date.toLocaleString();
                            }
                        },
                        { 
                            title: "Test", 
                            field: "test", 
                            headerFilter: true, 
                            width: "20%",
                            formatter: function(cell) {
                                const val = cell.getValue();
                                return `<code>${val}</code>`;
                            }
                        },
                        { 
                            title: "Test Categories", 
                            field: "testCategories", 
                            headerFilter: "list",
                            headerFilterParams: {
                                values: {
                                    "": "All",
                                    "Math": "Math",
                                    "Statistics": "Statistics",
                                    "Performance": "Performance",
                                    "Arrays": "Arrays",
                                    "Algorithms": "Algorithms"
                                }
                            },
                            width: "15%",
                            formatter: function(cell) {
                                const val = cell.getValue();
                                const categories = val.split(', ');
                                return categories.map(cat => `<span class="badge bg-light text-dark me-1">${cat}</span>`).join('');
                            }
                        },
                        { 
                            title: "Release", 
                            field: "release", 
                            headerFilter: "list",
                            headerFilterParams: {
                                values: {
                                    "": "All",
                                    "v2.1.0": "v2.1.0",
                                    "v2.0.9": "v2.0.9",
                                    "v2.0.8": "v2.0.8",
                                    "v2.0.7": "v2.0.7"
                                }
                            },
                            width: "10%",
                            formatter: function(cell) {
                                const val = cell.getValue();
                                return `<span class="badge bg-info text-dark">${val}</span>`;
                            }
                        },
                        { 
                            title: "Max Abs Diff", 
                            field: "maxAbsDiff", 
                            headerFilter: true, 
                            width: "10%",
                            formatter: function(cell) {
                                const val = cell.getValue();
                                const color = val > 0.01 ? 'text-danger' : val > 0.001 ? 'text-warning' : 'text-success';
                                return `<span class="${color} fw-bold">${val.toFixed(6)}</span>`;
                            },
                            sorter: "number"
                        },
                        { 
                            title: "Max Rel Diff", 
                            field: "maxRelDiff", 
                            headerFilter: true, 
                            width: "10%",
                            formatter: function(cell) {
                                const val = cell.getValue();
                                const color = val > 0.2 ? 'text-danger' : val > 0.1 ? 'text-warning' : 'text-success';
                                return `<span class="${color} fw-bold">${(val * 100).toFixed(2)}%</span>`;
                            },
                            sorter: "number"
                        },
                        { 
                            title: "Length Mismatch", 
                            field: "lengthMismatch", 
                            headerFilter: true, 
                            width: "10%",
                            formatter: function(cell) {
                                const val = cell.getValue();
                                const color = val > 0 ? 'text-danger' : 'text-success';
                                return `<span class="${color} fw-bold">${val}</span>`;
                            },
                            sorter: "number"
                        }
                    ],
                    height: "600px",
                    responsiveLayout: true,
                    movableColumns: true,
                    tooltips: true,
                });
            } catch (error) {
                console.error('Error initializing Tabulator:', error);
            }
        }

        // Add event listener for the history tab
        const historyTab = document.getElementById('tab-history');
        if (historyTab) {
            historyTab.addEventListener('shown.bs.tab', function() {
                // Use a longer timeout to ensure DOM is ready
                setTimeout(initializeNumericHistoryTable, 200);
            });
        }
    });
    </script>
</body>
</html>
